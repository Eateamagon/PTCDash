<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PTC Sign-Up Dashboard</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --primary: #2c5282;
      --primary-light: #ebf4ff;
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
      --green: #38a169;
      --green-bg: #c6f6d5;
      --yellow: #d69e2e;
      --yellow-bg: #fefcbf;
      --red: #e53e3e;
      --red-bg: #fed7d7;
      --gray-bg: #edf2f7;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Login */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .login-card {
      background: var(--card);
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      width: 380px;
      text-align: center;
    }

    .login-card h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .login-card p {
      color: var(--text-light);
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .login-card input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .login-card input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(44,82,130,0.15);
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
    }

    /* Dashboard */
    #dashboard { display: none; }

    .topbar {
      background: var(--primary);
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .topbar h1 { font-size: 1.2rem; }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .topbar-right span { font-size: 0.85rem; opacity: 0.9; }

    .btn-logout {
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .btn-logout:hover { background: rgba(255,255,255,0.25); }

    /* Admin toolbar */
    .admin-toolbar {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn-sync {
      background: var(--green);
      color: white;
    }

    .btn-upload-trigger {
      background: var(--primary);
      color: white;
    }

    #csv-file { display: none; }

    .sync-status {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    /* Summary cards */
    .summary-bar {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      overflow-x: auto;
    }

    .summary-card {
      background: var(--card);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      min-width: 150px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.15s;
    }

    .summary-card:hover { border-color: var(--primary); }
    .summary-card.active { border-color: var(--primary); background: var(--primary-light); }

    .summary-card h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }

    .summary-card .count {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
    }

    .summary-card .breakdown {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

    .mini-stat {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot-green { background: var(--green); }
    .dot-yellow { background: var(--yellow); }
    .dot-red { background: var(--red); }
    .dot-gray { background: #a0aec0; }

    /* Table */
    .table-container {
      padding: 0 1.5rem 2rem;
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .table-header h2 {
      font-size: 1.1rem;
      color: var(--text);
    }

    .legend {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    thead { background: var(--primary); color: white; }

    th {
      padding: 0.7rem 0.75rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 0.6rem 0.75rem;
      font-size: 0.88rem;
      border-bottom: 1px solid var(--border);
    }

    tr:last-child td { border-bottom: none; }

    tr.status-in_building { background: var(--green-bg); }
    tr.status-late { background: var(--yellow-bg); }
    tr.status-cancel { background: var(--red-bg); text-decoration: line-through; color: var(--text-light); }

    /* Status buttons */
    .status-btns {
      display: flex;
      gap: 4px;
    }

    .btn-status {
      padding: 0.3rem 0.55rem;
      font-size: 0.72rem;
      border-radius: 6px;
      font-weight: 600;
      border: 2px solid transparent;
    }

    .btn-in_building { background: var(--green-bg); color: var(--green); border-color: var(--green); }
    .btn-in_building.active { background: var(--green); color: white; }

    .btn-late { background: var(--yellow-bg); color: var(--yellow); border-color: var(--yellow); }
    .btn-late.active { background: var(--yellow); color: white; }

    .btn-cancel { background: var(--red-bg); color: var(--red); border-color: var(--red); }
    .btn-cancel.active { background: var(--red); color: white; }

    .btn-status:hover { opacity: 0.85; }

    /* Readonly notice */
    .readonly-badge {
      display: inline-block;
      background: var(--yellow-bg);
      color: var(--yellow);
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .admin-badge {
      display: inline-block;
      background: var(--green-bg);
      color: var(--green);
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .error-msg {
      color: var(--red);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-state h3 { margin-bottom: 0.5rem; }

    @media (max-width: 768px) {
      .summary-bar { flex-wrap: wrap; }
      .summary-card { min-width: 120px; flex: 1; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.5rem; }
      .status-btns { flex-direction: column; }
    }
  </style>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen">
  <div class="login-card">
    <h1>PTC Sign-Up Dashboard</h1>
    <p>Sign in with your school email</p>
    <input type="email" id="login-email" placeholder="your.email@waynesboro.k12.va.us" autocomplete="email">
    <button class="btn btn-primary" onclick="login()">Sign In</button>
    <div id="login-error" class="error-msg"></div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="topbar">
    <h1>PTC Sign-Up Dashboard</h1>
    <div class="topbar-right">
      <span id="user-info"></span>
      <button class="btn btn-logout" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <!-- Admin Toolbar -->
  <div class="admin-toolbar" id="admin-toolbar" style="display:none">
    <button class="btn btn-sync" onclick="syncSheet()">Sync from Google Sheet</button>
    <button class="btn btn-upload-trigger" onclick="document.getElementById('csv-file').click()">Upload CSV</button>
    <input type="file" id="csv-file" accept=".csv" onchange="uploadCSV(this)">
    <span class="sync-status" id="sync-status"></span>
  </div>

  <!-- Summary Cards -->
  <div class="summary-bar" id="summary-bar"></div>

  <!-- Data Table -->
  <div class="table-container">
    <div class="table-header">
      <h2 id="table-title">All Grades</h2>
      <div class="legend">
        <span class="legend-item"><span class="dot dot-green"></span> In Building</span>
        <span class="legend-item"><span class="dot dot-yellow"></span> Late</span>
        <span class="legend-item"><span class="dot dot-red"></span> Cancelled</span>
        <span class="legend-item"><span class="dot dot-gray"></span> Pending</span>
      </div>
    </div>
    <div id="table-area"></div>
  </div>
</div>

<script>
  let currentUser = null;
  let currentGrade = null; // null = all grades

  // Check if already logged in
  fetch('/api/me').then(r => r.ok ? r.json() : null).then(user => {
    if (user) { currentUser = user; showDashboard(); }
  });

  // Enter key on login
  document.getElementById('login-email').addEventListener('keydown', e => {
    if (e.key === 'Enter') login();
  });

  async function login() {
    const email = document.getElementById('login-email').value.trim();
    if (!email) return;

    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });

    if (res.ok) {
      currentUser = await res.json();
      showDashboard();
    } else {
      document.getElementById('login-error').textContent = 'Login failed';
    }
  }

  async function logout() {
    await fetch('/api/logout', { method: 'POST' });
    currentUser = null;
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
  }

  function showDashboard() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    const badge = currentUser.role === 'admin'
      ? '<span class="admin-badge">ADMIN</span>'
      : '<span class="readonly-badge">READ ONLY</span>';
    document.getElementById('user-info').innerHTML = `${currentUser.email} ${badge}`;

    if (currentUser.role === 'admin') {
      document.getElementById('admin-toolbar').style.display = 'flex';
    }

    loadData();
  }

  async function loadData() {
    await Promise.all([loadSummary(), loadSignups()]);
  }

  async function loadSummary() {
    const res = await fetch('/api/summary');
    if (!res.ok) return;
    const data = await res.json();

    const bar = document.getElementById('summary-bar');
    let html = '';

    // All grades card
    const t = data.totals;
    html += summaryCard('All Grades', null, t.total, t.in_building, t.late, t.cancelled, t.pending);

    // Individual grade cards
    for (const g of data.grades) {
      html += summaryCard(g.grade, g.grade, g.total, g.in_building, g.late, g.cancelled, g.pending);
    }

    bar.innerHTML = html;

    // Highlight active
    bar.querySelectorAll('.summary-card').forEach(card => {
      const g = card.dataset.grade;
      if ((g === '' && currentGrade === null) || g === currentGrade) {
        card.classList.add('active');
      }
    });
  }

  function summaryCard(label, grade, total, inB, late, cancel, pending) {
    const gradeAttr = grade === null ? '' : grade;
    const active = (grade === null && currentGrade === null) || grade === currentGrade ? ' active' : '';
    return `
      <div class="summary-card${active}" data-grade="${gradeAttr}" onclick="filterGrade(${grade === null ? 'null' : `'${grade}'`})">
        <h3>${label}</h3>
        <div class="count">${total}</div>
        <div class="breakdown">
          <span class="mini-stat"><span class="dot dot-green"></span>${inB}</span>
          <span class="mini-stat"><span class="dot dot-yellow"></span>${late}</span>
          <span class="mini-stat"><span class="dot dot-red"></span>${cancel}</span>
          <span class="mini-stat"><span class="dot dot-gray"></span>${pending}</span>
        </div>
      </div>`;
  }

  async function loadSignups() {
    const url = currentGrade ? `/api/signups?grade=${encodeURIComponent(currentGrade)}` : '/api/signups';
    const res = await fetch(url);
    if (!res.ok) return;
    const signups = await res.json();

    document.getElementById('table-title').textContent = currentGrade || 'All Grades';

    if (signups.length === 0) {
      document.getElementById('table-area').innerHTML = `
        <div class="empty-state">
          <h3>No sign-ups yet</h3>
          <p>${currentUser.role === 'admin' ? 'Click "Sync from Google Sheet" or "Upload CSV" to import data.' : 'Data has not been imported yet.'}</p>
        </div>`;
      return;
    }

    const isAdmin = currentUser.role === 'admin';

    let html = `<table>
      <thead><tr>
        <th>Time Slot</th>
        <th>Grade</th>
        <th>Student (Comment)</th>
        <th>Parent</th>
        <th>Email</th>
        <th>Qty</th>
        ${isAdmin ? '<th>Status</th>' : '<th>Status</th>'}
      </tr></thead><tbody>`;

    for (const s of signups) {
      const timeSlot = formatTime(s.start_datetime) + ' - ' + formatTime(s.end_datetime);
      const statusClass = s.status !== 'none' ? ` status-${s.status}` : '';
      const statusLabel = statusText(s.status);

      html += `<tr class="${statusClass}" id="row-${s.id}">
        <td>${esc(timeSlot)}</td>
        <td>${esc(s.item)}</td>
        <td><strong>${esc(s.signup_comment || 'â€”')}</strong></td>
        <td>${esc(s.first_name)} ${esc(s.last_name)}</td>
        <td>${esc(s.email)}</td>
        <td>${s.qty}</td>
        <td>${isAdmin ? statusButtons(s.id, s.status) : `<span>${statusLabel}</span>`}</td>
      </tr>`;
    }

    html += '</tbody></table>';
    document.getElementById('table-area').innerHTML = html;
  }

  function statusButtons(id, current) {
    return `<div class="status-btns">
      <button class="btn btn-status btn-in_building${current === 'in_building' ? ' active' : ''}"
        onclick="setStatus(${id}, '${current === 'in_building' ? 'none' : 'in_building'}')">In Building</button>
      <button class="btn btn-status btn-late${current === 'late' ? ' active' : ''}"
        onclick="setStatus(${id}, '${current === 'late' ? 'none' : 'late'}')">Late</button>
      <button class="btn btn-status btn-cancel${current === 'cancel' ? ' active' : ''}"
        onclick="setStatus(${id}, '${current === 'cancel' ? 'none' : 'cancel'}')">Cancel</button>
    </div>`;
  }

  async function setStatus(id, status) {
    const res = await fetch(`/api/signups/${id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    if (res.ok) loadData();
  }

  function filterGrade(grade) {
    currentGrade = grade;
    loadData();
  }

  async function syncSheet() {
    const statusEl = document.getElementById('sync-status');
    statusEl.textContent = 'Syncing from Google Sheet...';

    const res = await fetch('/api/sync', { method: 'POST' });
    const data = await res.json();

    if (res.ok) {
      statusEl.textContent = `Synced! ${data.inserted} new, ${data.updated} updated, ${data.skipped} skipped.`;
      loadData();
    } else {
      statusEl.textContent = `Error: ${data.error}`;
    }

    setTimeout(() => { statusEl.textContent = ''; }, 5000);
  }

  async function uploadCSV(input) {
    if (!input.files[0]) return;
    const statusEl = document.getElementById('sync-status');
    statusEl.textContent = 'Uploading CSV...';

    const formData = new FormData();
    formData.append('csv', input.files[0]);

    const res = await fetch('/api/upload', { method: 'POST', body: formData });
    const data = await res.json();

    if (res.ok) {
      statusEl.textContent = `Uploaded! ${data.inserted} new, ${data.updated} updated, ${data.skipped} skipped.`;
      loadData();
    } else {
      statusEl.textContent = `Error: ${data.error}`;
    }

    input.value = '';
    setTimeout(() => { statusEl.textContent = ''; }, 5000);
  }

  function formatTime(dt) {
    if (!dt) return '';
    // Input: "2/16/2026 12:00" -> "12:00 PM"
    const parts = dt.split(' ');
    if (parts.length < 2) return dt;
    const date = parts[0];
    const timeParts = parts[1].split(':');
    let h = parseInt(timeParts[0], 10);
    const m = timeParts[1] || '00';
    const ampm = h >= 12 ? 'PM' : 'AM';
    if (h > 12) h -= 12;
    if (h === 0) h = 12;
    return `${date} ${h}:${m} ${ampm}`;
  }

  function statusText(s) {
    const map = { none: 'Pending', in_building: 'In Building', late: 'Late', cancel: 'Cancelled' };
    return map[s] || s;
  }

  function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }
</script>
</body>
</html>
