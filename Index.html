<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --bg: #f7f5fa;
      --card: #ffffff;
      --primary: #4A2072;
      --primary-light: #f0e6f6;
      --gold: #C8A415;
      --gold-light: #fdf6d8;
      --text: #2d2740;
      --text-light: #6b6280;
      --border: #e0dae8;
      --green: #38a169;
      --green-bg: #c6f6d5;
      --yellow: #d69e2e;
      --yellow-bg: #fefcbf;
      --red: #e53e3e;
      --red-bg: #fed7d7;
      --gray-bg: #edf2f7;
      --open-bg: #f0f0f0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    #loading {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      flex-direction: column;
      gap: 1rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .topbar {
      background: linear-gradient(135deg, var(--primary) 0%, #5C2D91 100%);
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(74,32,114,0.3);
      border-bottom: 3px solid var(--gold);
    }

    .topbar h1 { font-size: 1.2rem; }

    .topbar .kcms-label {
      font-weight: 800;
      color: var(--gold);
      margin-right: 0.4rem;
      letter-spacing: 1px;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.85rem;
    }

    .admin-badge {
      display: inline-block;
      background: var(--green-bg);
      color: var(--green);
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .readonly-badge {
      display: inline-block;
      background: var(--yellow-bg);
      color: var(--yellow);
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .toolbar {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.55rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.15s;
    }

    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-sync { background: var(--primary); color: white; }
    .btn-upload { background: var(--gold); color: #2d2740; font-weight: 600; }

    #csv-file-input { display: none; }

    .toolbar-status {
      font-size: 0.85rem;
      color: var(--text-light);
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .refresh-timer {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: var(--primary);
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    /* Date tabs */
    .date-tabs {
      display: flex;
      gap: 0;
      padding: 0 1.5rem;
      border-bottom: 2px solid var(--border);
      background: var(--card);
    }

    .date-tab {
      padding: 0.7rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-light);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.15s;
    }

    .date-tab:hover { color: var(--primary); }

    .date-tab.active {
      color: var(--primary);
      border-bottom-color: var(--gold);
    }

    .summary-bar {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      overflow-x: auto;
    }

    .summary-card {
      background: var(--card);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      min-width: 150px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.15s;
      user-select: none;
    }

    .summary-card:hover { border-color: var(--gold); }
    .summary-card.active { border-color: var(--gold); background: var(--gold-light); }

    .summary-card h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }

    .summary-card .count {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--gold);
    }

    .summary-card .sub-count {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.15rem;
    }

    .summary-card .breakdown {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

    .mini-stat {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot-green { background: var(--green); }
    .dot-yellow { background: var(--yellow); }
    .dot-red { background: var(--red); }
    .dot-gray { background: #a0aec0; }

    /* Main content layout with sidebar */
    .content-wrapper {
      display: flex;
    }

    .timeline-sidebar {
      width: 70px;
      min-width: 70px;
      background: var(--card);
      border-right: 2px solid var(--border);
      position: relative;
      padding: 0.5rem 0;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 160px);
    }

    .timeline-header {
      text-align: center;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-light);
      letter-spacing: 0.5px;
      padding: 0.25rem 0 0.4rem;
      border-bottom: 1px solid var(--border);
    }

    .timeline-clock {
      text-align: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--primary);
      padding: 0.35rem 0;
      border-bottom: 1px solid var(--border);
      font-variant-numeric: tabular-nums;
    }

    .timeline-slots {
      flex: 1;
      position: relative;
      overflow: hidden;
      padding: 0.25rem 0;
    }

    .timeline-slot {
      font-size: 0.6rem;
      text-align: center;
      padding: 0.3rem 0.15rem;
      color: var(--text-light);
      border-bottom: 1px solid var(--border);
      position: relative;
      line-height: 1.2;
    }

    .timeline-slot.tl-past {
      color: #b0a8bf;
    }

    .timeline-slot.tl-active {
      background: var(--gold-light);
      color: var(--primary);
      font-weight: 700;
      border-left: 3px solid var(--gold);
    }

    .timeline-slot.tl-future {
      color: var(--text);
    }

    .timeline-now-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--red);
      z-index: 2;
      pointer-events: none;
    }

    .timeline-now-line::before {
      content: '';
      position: absolute;
      left: -3px;
      top: -3px;
      width: 8px;
      height: 8px;
      background: var(--red);
      border-radius: 50%;
    }

    .main-content {
      flex: 1;
      min-width: 0;
    }

    .table-container { padding: 0 1.5rem 2rem; }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .table-header h2 { font-size: 1.1rem; }

    .legend {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    thead { background: var(--primary); color: white; }

    th {
      padding: 0.7rem 0.75rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    td {
      padding: 0.6rem 0.75rem;
      font-size: 0.88rem;
      border-bottom: 1px solid var(--border);
    }

    tr:last-child td { border-bottom: none; }

    /* Time slot group header row */
    tr.slot-header td {
      background: var(--primary-light);
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--primary);
      padding: 0.5rem 0.75rem;
      border-bottom: 2px solid var(--primary);
    }

    tr.status-in_building { background: var(--green-bg); }
    tr.status-late { background: var(--yellow-bg); }
    tr.status-cancel { background: var(--red-bg); }
    tr.status-cancel td { text-decoration: line-through; color: var(--text-light); }
    tr.status-cancel td:last-child { text-decoration: none; }

    tr.empty-slot { background: var(--open-bg); }
    tr.empty-slot td { color: var(--text-light); font-style: italic; }

    .status-btns { display: flex; gap: 4px; }

    .btn-status {
      padding: 0.3rem 0.55rem;
      font-size: 0.72rem;
      border-radius: 6px;
      font-weight: 600;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-status:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-ib { background: var(--green-bg); color: var(--green); border-color: var(--green); }
    .btn-ib.active { background: var(--green); color: white; }

    .btn-lt { background: var(--yellow-bg); color: var(--yellow); border-color: var(--yellow); }
    .btn-lt.active { background: var(--yellow); color: white; }

    .btn-cn { background: var(--red-bg); color: var(--red); border-color: var(--red); }
    .btn-cn.active { background: var(--red); color: white; }

    .status-label {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .status-label.sl-in_building { background: var(--green-bg); color: var(--green); }
    .status-label.sl-late { background: var(--yellow-bg); color: var(--yellow); }
    .status-label.sl-cancel { background: var(--red-bg); color: var(--red); }
    .status-label.sl-none { background: var(--gray-bg); color: var(--text-light); }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-state h3 { margin-bottom: 0.5rem; }

    /* Upload modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--card);
      border-radius: 12px;
      padding: 2rem;
      width: 420px;
      max-width: 90vw;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }

    .modal h3 {
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .modal p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 1rem;
    }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      margin-bottom: 1rem;
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .upload-zone.dragover {
      border-color: var(--green);
      background: var(--green-bg);
    }

    .upload-zone p { margin: 0; color: var(--text-light); }
    .upload-zone .file-name { color: var(--primary); font-weight: 600; margin-top: 0.5rem; }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .btn-cancel-modal {
      background: var(--gray-bg);
      color: var(--text);
    }

    .upload-progress {
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: center;
      padding: 0.5rem 0;
    }

    .upload-result {
      font-size: 0.85rem;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .upload-result.success { background: var(--green-bg); color: var(--green); }
    .upload-result.error { background: var(--red-bg); color: var(--red); }

    @media (max-width: 768px) {
      .summary-bar { flex-wrap: wrap; }
      .summary-card { min-width: 120px; flex: 1; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.5rem; }
      .status-btns { flex-direction: column; }
      .topbar { flex-direction: column; gap: 0.5rem; text-align: center; }
      .toolbar { justify-content: center; }
      .timeline-sidebar { display: none; }
    }
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div style="color:var(--text-light)">Loading dashboard...</div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none">
  <div class="topbar">
    <h1><span class="kcms-label">KCMS</span> PTC Sign-Up Dashboard</h1>
    <div class="topbar-right">
      <span id="user-info"></span>
    </div>
  </div>

  <div class="toolbar">
    <button class="btn btn-sync" id="btn-refresh" onclick="doRefresh()">Refresh Data</button>
    <div class="toolbar-divider" id="admin-divider" style="display:none"></div>
    <button class="btn btn-upload" id="btn-upload" style="display:none" onclick="openUploadModal()">Upload CSV</button>
    <span class="toolbar-status" id="toolbar-status">
      <span id="toolbar-msg"></span>
      <span class="refresh-timer" id="refresh-timer"></span>
    </span>
  </div>

  <div class="date-tabs" id="date-tabs"></div>

  <div class="content-wrapper">
    <div class="timeline-sidebar" id="timeline-sidebar">
      <div class="timeline-header">EST Time</div>
      <div class="timeline-clock" id="timeline-clock"></div>
      <div class="timeline-slots" id="timeline-slots"></div>
    </div>

    <div class="main-content">
      <div class="summary-bar" id="summary-bar"></div>

      <div class="table-container">
        <div class="table-header">
          <h2 id="table-title">All Grades</h2>
          <div class="legend">
            <span class="legend-item"><span class="dot dot-green"></span> In Building</span>
            <span class="legend-item"><span class="dot dot-yellow"></span> Late</span>
            <span class="legend-item"><span class="dot dot-red"></span> Cancelled</span>
            <span class="legend-item"><span class="dot dot-gray"></span> Pending</span>
          </div>
        </div>
        <div id="table-area"></div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay" id="upload-modal">
  <div class="modal">
    <h3>Upload CSV Export</h3>
    <p>Upload a SignUpGenius CSV export. Existing data won't be overwritten &mdash; only blank fields will be filled in. New rows will be added.</p>
    <div id="upload-result"></div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('csv-file-input').click()">
      <p>Click to select a CSV file or drag &amp; drop</p>
      <div class="file-name" id="file-name-display"></div>
    </div>
    <input type="file" id="csv-file-input" accept=".csv" onchange="onFileSelected(this)">
    <div id="upload-progress" class="upload-progress" style="display:none">
      <div class="spinner" style="width:24px;height:24px;margin:0 auto"></div>
      <div style="margin-top:0.5rem">Uploading and merging data...</div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel-modal" onclick="closeUploadModal()">Cancel</button>
      <button class="btn btn-upload" id="btn-do-upload" onclick="doUpload()" disabled>Upload &amp; Merge</button>
    </div>
  </div>
</div>

<script>
  var currentUser = null;
  var currentGrade = null;
  var currentDate = null; // null = both days
  var selectedFile = null;
  var allSignups = [];
  var allSummary = null;
  var lastRefreshTime = null;
  var refreshTimerInterval = null;
  var timelineInterval = null;

  // ── Init ─────────────────────────────────────────────────────

  google.script.run
    .withSuccessHandler(function(user) {
      currentUser = user;
      initDashboard();
    })
    .withFailureHandler(function(err) {
      document.getElementById('loading').innerHTML =
        '<div style="color:#e53e3e;text-align:center;padding:2rem"><h3>Unable to load</h3><p>' + err.message + '</p></div>';
    })
    .getCurrentUser();

  function initDashboard() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    var badge = currentUser.role === 'admin'
      ? '<span class="admin-badge">ADMIN</span>'
      : '<span class="readonly-badge">READ ONLY</span>';
    document.getElementById('user-info').innerHTML = currentUser.email + ' ' + badge;

    if (currentUser.role === 'admin') {
      document.getElementById('btn-upload').style.display = '';
      document.getElementById('admin-divider').style.display = '';
    }

    setupDragDrop();
    startTimelineClock();
    loadData();
  }

  // ── Data Loading ─────────────────────────────────────────────

  function showMsg(msg) {
    document.getElementById('toolbar-msg').textContent = msg;
  }

  function startRefreshTimer() {
    lastRefreshTime = Date.now();
    if (refreshTimerInterval) clearInterval(refreshTimerInterval);
    updateRefreshTimer();
    refreshTimerInterval = setInterval(updateRefreshTimer, 1000);
  }

  function updateRefreshTimer() {
    if (!lastRefreshTime) return;
    var elapsed = Math.floor((Date.now() - lastRefreshTime) / 1000);
    var min = Math.floor(elapsed / 60);
    var sec = elapsed % 60;
    var text = min > 0 ? min + 'm ' + sec + 's ago' : sec + 's ago';
    document.getElementById('refresh-timer').textContent = text;
  }

  function loadData() {
    showMsg('Loading...');
    google.script.run
      .withSuccessHandler(function(result) {
        allSignups = result.signups;
        allSummary = result.summary;
        renderDateTabs();
        applyFilters();
        renderTimeline();
        showMsg('Data loaded');
        startRefreshTimer();
      })
      .withFailureHandler(function(err) {
        showMsg('Error: ' + err.message);
      })
      .getSignups(null);
  }

  function doRefresh() {
    var btn = document.getElementById('btn-refresh');
    btn.disabled = true;
    showMsg('Refreshing...');

    google.script.run
      .withSuccessHandler(function(result) {
        allSignups = result.signups;
        allSummary = result.summary;
        renderDateTabs();
        applyFilters();
        renderTimeline();
        showMsg('Data refreshed');
        startRefreshTimer();
        btn.disabled = false;
      })
      .withFailureHandler(function(err) {
        showMsg('Error: ' + err.message);
        btn.disabled = false;
      })
      .refreshData(null);
  }

  function filterGrade(grade) {
    currentGrade = grade;
    applyFilters();
  }

  // ── Date Filtering ──────────────────────────────────────────

  function extractDates(signups) {
    var dateSet = {};
    for (var i = 0; i < signups.length; i++) {
      var dt = signups[i].start_datetime;
      if (!dt) continue;
      var datePart = String(dt).split(' ')[0]; // e.g. "2/16/2026"
      if (datePart) dateSet[datePart] = true;
    }
    var dates = Object.keys(dateSet);
    dates.sort(function(a, b) {
      var pa = a.split('/'), pb = b.split('/');
      var da = new Date(pa[2], pa[0] - 1, pa[1]);
      var db = new Date(pb[2], pb[0] - 1, pb[1]);
      return da - db;
    });
    return dates;
  }

  function renderDateTabs() {
    var dates = extractDates(allSignups);
    var container = document.getElementById('date-tabs');

    if (dates.length <= 1) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'flex';
    var html = '<button class="date-tab' + (currentDate === null ? ' active' : '') +
      '" onclick="filterDate(null)">Both Days</button>';

    for (var i = 0; i < dates.length; i++) {
      var d = dates[i];
      var label = formatDateLabel(d);
      var active = currentDate === d ? ' active' : '';
      html += '<button class="date-tab' + active + '" onclick="filterDate(\'' + esc(d) + '\')">' + esc(label) + '</button>';
    }

    container.innerHTML = html;
  }

  function formatDateLabel(dateStr) {
    var parts = dateStr.split('/');
    var dt = new Date(parts[2], parts[0] - 1, parts[1]);
    var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return days[dt.getDay()] + ', ' + months[dt.getMonth()] + ' ' + parts[1];
  }

  function filterDate(date) {
    currentDate = date;
    renderDateTabs();
    applyFilters();
    renderTimeline();
  }

  function filterSignupsByDate(signups) {
    if (currentDate === null) return signups;
    var filtered = [];
    for (var i = 0; i < signups.length; i++) {
      var dt = signups[i].start_datetime;
      if (dt && String(dt).split(' ')[0] === currentDate) {
        filtered.push(signups[i]);
      }
    }
    return filtered;
  }

  function filterSignupsByGrade(signups) {
    if (currentGrade === null) return signups;
    var filtered = [];
    for (var i = 0; i < signups.length; i++) {
      if (signups[i].item === currentGrade) {
        filtered.push(signups[i]);
      }
    }
    return filtered;
  }

  function computeSummary(signups) {
    var grades = {};
    var totals = { total: 0, in_building: 0, late: 0, cancelled: 0, pending: 0, open_slots: 0 };

    for (var i = 0; i < signups.length; i++) {
      var s = signups[i];
      var g = s.item || 'Unknown';

      if (!grades[g]) {
        grades[g] = { grade: g, total: 0, in_building: 0, late: 0, cancelled: 0, pending: 0, open_slots: 0 };
      }

      if (s.is_empty_slot) {
        grades[g].open_slots++;
        totals.open_slots++;
        continue;
      }

      grades[g].total++;
      totals.total++;

      var st = s.status || 'none';
      if (st === 'in_building') { grades[g].in_building++; totals.in_building++; }
      else if (st === 'late') { grades[g].late++; totals.late++; }
      else if (st === 'cancel') { grades[g].cancelled++; totals.cancelled++; }
      else { grades[g].pending++; totals.pending++; }
    }

    var gradeList = [];
    for (var k in grades) gradeList.push(grades[k]);
    gradeList.sort(function(a, b) { return a.grade < b.grade ? -1 : 1; });

    return { totals: totals, grades: gradeList };
  }

  function applyFilters() {
    // Date filter first for summary (so grade cards show date-filtered counts)
    var dateFiltered = filterSignupsByDate(allSignups);
    var summary = (currentDate !== null) ? computeSummary(dateFiltered) : allSummary;
    renderSummary(summary);

    // Then apply grade filter for the table
    var tableData = filterSignupsByGrade(dateFiltered);
    renderTable(tableData);
  }

  // ── Timeline Sidebar ─────────────────────────────────────────

  function getESTNow() {
    // Get current time in EST/EDT
    var now = new Date();
    var estStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
    return new Date(estStr);
  }

  function startTimelineClock() {
    updateTimelineClock();
    timelineInterval = setInterval(function() {
      updateTimelineClock();
      updateTimelineNow();
    }, 1000);
  }

  function updateTimelineClock() {
    var est = getESTNow();
    var h = est.getHours();
    var m = est.getMinutes();
    var s = est.getSeconds();
    var ampm = h >= 12 ? 'PM' : 'AM';
    var h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
    var timeStr = h12 + ':' + pad2(m) + ':' + pad2(s) + ' ' + ampm;
    document.getElementById('timeline-clock').textContent = timeStr;
  }

  function pad2(n) { return n < 10 ? '0' + n : '' + n; }

  function extractTimeSlots(signups) {
    // Get unique time slots from the signups for the selected date
    var filtered = filterSignupsByDate(signups);
    var slotMap = {};
    for (var i = 0; i < filtered.length; i++) {
      var s = filtered[i];
      if (!s.start_datetime || !s.end_datetime) continue;
      var key = s.start_datetime + '|' + s.end_datetime;
      if (!slotMap[key]) {
        slotMap[key] = { start: s.start_datetime, end: s.end_datetime };
      }
    }
    var slots = [];
    for (var k in slotMap) slots.push(slotMap[k]);
    slots.sort(function(a, b) {
      return parseDateToMs(a.start) - parseDateToMs(b.start);
    });
    return slots;
  }

  function parseDateToMs(dtStr) {
    if (!dtStr) return 0;
    var match = dtStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})$/);
    if (!match) return 0;
    return new Date(
      parseInt(match[3]), parseInt(match[1]) - 1, parseInt(match[2]),
      parseInt(match[4]), parseInt(match[5])
    ).getTime();
  }

  function renderTimeline() {
    var slots = extractTimeSlots(allSignups);
    var container = document.getElementById('timeline-slots');

    if (slots.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:var(--text-light);font-size:0.65rem;padding:1rem 0.25rem">No slots</div>';
      return;
    }

    var est = getESTNow();
    var nowMs = est.getTime();

    var html = '';
    for (var i = 0; i < slots.length; i++) {
      var slot = slots[i];
      var startMs = parseDateToMs(slot.start);
      var endMs = parseDateToMs(slot.end);

      var cls = 'timeline-slot';
      if (nowMs >= startMs && nowMs < endMs) cls += ' tl-active';
      else if (nowMs >= endMs) cls += ' tl-past';
      else cls += ' tl-future';

      var startLabel = formatTimeShort(slot.start);
      html += '<div class="' + cls + '" data-start="' + startMs + '" data-end="' + endMs + '">' +
        startLabel + '</div>';
    }

    container.innerHTML = html;
    updateTimelineNow();
  }

  function updateTimelineNow() {
    // Remove old now-line
    var old = document.querySelector('.timeline-now-line');
    if (old) old.parentNode.removeChild(old);

    var container = document.getElementById('timeline-slots');
    var slotEls = container.querySelectorAll('.timeline-slot');
    if (slotEls.length === 0) return;

    var est = getESTNow();
    var nowMs = est.getTime();

    // Find the overall range of the timeline
    var firstStart = parseInt(slotEls[0].getAttribute('data-start'));
    var lastEnd = parseInt(slotEls[slotEls.length - 1].getAttribute('data-end'));

    if (nowMs < firstStart || nowMs > lastEnd) return;

    // Calculate vertical position as percentage of container height
    var totalRange = lastEnd - firstStart;
    if (totalRange <= 0) return;
    var pct = (nowMs - firstStart) / totalRange;
    var containerHeight = container.scrollHeight;
    var topPx = Math.round(pct * containerHeight);

    var line = document.createElement('div');
    line.className = 'timeline-now-line';
    line.style.top = topPx + 'px';
    container.appendChild(line);

    // Update active states on slots
    for (var i = 0; i < slotEls.length; i++) {
      var el = slotEls[i];
      var s = parseInt(el.getAttribute('data-start'));
      var e = parseInt(el.getAttribute('data-end'));
      el.className = 'timeline-slot' +
        (nowMs >= s && nowMs < e ? ' tl-active' : nowMs >= e ? ' tl-past' : ' tl-future');
    }
  }

  function formatTimeShort(dtStr) {
    if (!dtStr) return '';
    var parts = dtStr.split(' ');
    if (parts.length < 2) return dtStr;
    var timeParts = parts[1].split(':');
    var h = parseInt(timeParts[0], 10);
    var m = timeParts[1] || '00';
    var ampm = h >= 12 ? 'PM' : 'AM';
    if (h > 12) h -= 12;
    if (h === 0) h = 12;
    return h + ':' + m + (ampm === 'AM' ? 'a' : 'p');
  }

  // ── CSV Upload ───────────────────────────────────────────────

  function openUploadModal() {
    selectedFile = null;
    document.getElementById('csv-file-input').value = '';
    document.getElementById('file-name-display').textContent = '';
    document.getElementById('btn-do-upload').disabled = true;
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('upload-result').innerHTML = '';
    document.getElementById('upload-modal').classList.add('show');
  }

  function closeUploadModal() {
    document.getElementById('upload-modal').classList.remove('show');
  }

  function onFileSelected(input) {
    if (input.files && input.files[0]) {
      selectedFile = input.files[0];
      document.getElementById('file-name-display').textContent = selectedFile.name;
      document.getElementById('btn-do-upload').disabled = false;
    }
  }

  function setupDragDrop() {
    var zone = document.getElementById('upload-zone');
    zone.addEventListener('dragover', function(e) {
      e.preventDefault();
      zone.classList.add('dragover');
    });
    zone.addEventListener('dragleave', function() {
      zone.classList.remove('dragover');
    });
    zone.addEventListener('drop', function(e) {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        selectedFile = e.dataTransfer.files[0];
        document.getElementById('file-name-display').textContent = selectedFile.name;
        document.getElementById('btn-do-upload').disabled = false;
      }
    });
  }

  function doUpload() {
    if (!selectedFile) return;

    document.getElementById('btn-do-upload').disabled = true;
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('upload-result').innerHTML = '';

    var reader = new FileReader();
    reader.onload = function(e) {
      var csvContent = e.target.result;
      google.script.run
        .withSuccessHandler(function(result) {
          closeUploadModal();
          showMsg('Upload complete! ' + result.inserted + ' new, ' +
                  result.updated + ' updated, ' + result.skipped + ' unchanged.');
          loadData();
        })
        .withFailureHandler(function(err) {
          document.getElementById('upload-progress').style.display = 'none';
          document.getElementById('upload-result').innerHTML =
            '<div class="upload-result error"><strong>Error:</strong> ' +
            (err.message || String(err)) + '</div>';
          document.getElementById('btn-do-upload').disabled = false;
        })
        .uploadCSV(csvContent);
    };
    reader.readAsText(selectedFile);
  }

  // ── Render Summary ───────────────────────────────────────────

  function renderSummary(summary) {
    var bar = document.getElementById('summary-bar');
    var html = '';
    var t = summary.totals;
    html += summaryCardHtml('All Grades', null, t.total, t.in_building, t.late, t.cancelled, t.pending, t.open_slots);

    for (var i = 0; i < summary.grades.length; i++) {
      var g = summary.grades[i];
      html += summaryCardHtml(g.grade, g.grade, g.total, g.in_building, g.late, g.cancelled, g.pending, g.open_slots);
    }

    bar.innerHTML = html;
  }

  function summaryCardHtml(label, grade, total, inB, late, cancel, pending, openSlots) {
    var active = (grade === currentGrade) || (grade === null && currentGrade === null) ? ' active' : '';
    var onclick = grade === null ? 'filterGrade(null)' : "filterGrade('" + esc(grade) + "')";
    var openText = openSlots > 0 ? '<div class="sub-count">' + openSlots + ' open slot' + (openSlots !== 1 ? 's' : '') + '</div>' : '';
    return '<div class="summary-card' + active + '" onclick="' + onclick + '">' +
      '<h3>' + esc(label) + '</h3>' +
      '<div class="count">' + total + '</div>' +
      openText +
      '<div class="breakdown">' +
        '<span class="mini-stat"><span class="dot dot-green"></span>' + inB + '</span>' +
        '<span class="mini-stat"><span class="dot dot-yellow"></span>' + late + '</span>' +
        '<span class="mini-stat"><span class="dot dot-red"></span>' + cancel + '</span>' +
        '<span class="mini-stat"><span class="dot dot-gray"></span>' + pending + '</span>' +
      '</div></div>';
  }

  // ── Render Table ─────────────────────────────────────────────

  function renderTable(signups) {
    document.getElementById('table-title').textContent = currentGrade || 'All Grades';

    if (!signups || signups.length === 0) {
      document.getElementById('table-area').innerHTML =
        '<div class="empty-state"><h3>No sign-ups found</h3><p>No data available for this view.' +
        (currentUser.role === 'admin' ? ' Use "Upload CSV" to import data.' : '') + '</p></div>';
      return;
    }

    var isAdmin = currentUser.role === 'admin';

    var html = '<table><thead><tr>' +
      '<th>Time Slot</th><th>Grade</th><th>Student</th>' +
      '<th>Parent</th><th>Email</th><th>Qty</th><th>Status</th>' +
      '</tr></thead><tbody>';

    var lastTimeSlot = '';

    for (var i = 0; i < signups.length; i++) {
      var s = signups[i];
      var timeSlot = formatTime(s.start_datetime) + ' \u2013 ' + formatTime(s.end_datetime);

      // Group header row when time slot changes
      if (timeSlot !== lastTimeSlot) {
        // Count entries in this time block
        var blockCount = 0;
        var blockOpen = 0;
        for (var j = i; j < signups.length; j++) {
          var ts2 = formatTime(signups[j].start_datetime) + ' \u2013 ' + formatTime(signups[j].end_datetime);
          if (ts2 !== timeSlot) break;
          if (signups[j].is_empty_slot) blockOpen++;
          else blockCount++;
        }
        var blockLabel = timeSlot + '  \u2014  ' + blockCount + ' signed up' +
          (blockOpen > 0 ? ', ' + blockOpen + ' open' : '');
        html += '<tr class="slot-header"><td colspan="7">' + esc(blockLabel) + '</td></tr>';
        lastTimeSlot = timeSlot;
      }

      if (s.is_empty_slot) {
        html += '<tr class="empty-slot">' +
          '<td></td>' +
          '<td>' + esc(s.item) + '</td>' +
          '<td>Open Slot</td>' +
          '<td></td><td></td>' +
          '<td></td><td></td></tr>';
        continue;
      }

      var statusClass = s.status !== 'none' ? ' status-' + s.status : '';

      html += '<tr class="' + statusClass + '" id="row-' + i + '">' +
        '<td></td>' +
        '<td>' + esc(s.item) + '</td>' +
        '<td><strong>' + esc(s.signup_comment || '\u2014') + '</strong></td>' +
        '<td>' + esc(s.first_name) + ' ' + esc(s.last_name) + '</td>' +
        '<td>' + esc(s.email) + '</td>' +
        '<td>' + (s.qty || 1) + '</td>' +
        '<td>' + (isAdmin ? statusButtonsHtml(i, s.key, s.status) : statusLabelHtml(s.status)) + '</td>' +
        '</tr>';
    }

    html += '</tbody></table>';
    document.getElementById('table-area').innerHTML = html;
  }

  function statusButtonsHtml(idx, key, current) {
    var ibActive = current === 'in_building' ? ' active' : '';
    var ltActive = current === 'late' ? ' active' : '';
    var cnActive = current === 'cancel' ? ' active' : '';

    var ibTarget = current === 'in_building' ? 'none' : 'in_building';
    var ltTarget = current === 'late' ? 'none' : 'late';
    var cnTarget = current === 'cancel' ? 'none' : 'cancel';

    return '<div class="status-btns">' +
      '<button class="btn-status btn-ib' + ibActive + '" onclick="clickStatus(' + idx + ',\'' + escAttr(key) + '\',\'' + ibTarget + '\')">In Building</button>' +
      '<button class="btn-status btn-lt' + ltActive + '" onclick="clickStatus(' + idx + ',\'' + escAttr(key) + '\',\'' + ltTarget + '\')">Late</button>' +
      '<button class="btn-status btn-cn' + cnActive + '" onclick="clickStatus(' + idx + ',\'' + escAttr(key) + '\',\'' + cnTarget + '\')">Cancel</button>' +
      '</div>';
  }

  function statusLabelHtml(status) {
    var labels = { none: 'Pending', in_building: 'In Building', late: 'Late', cancel: 'Cancelled' };
    return '<span class="status-label sl-' + status + '">' + (labels[status] || status) + '</span>';
  }

  // ── Status Update ────────────────────────────────────────────

  function clickStatus(idx, key, newStatus) {
    var row = document.getElementById('row-' + idx);
    if (row) {
      var btns = row.querySelectorAll('.btn-status');
      for (var i = 0; i < btns.length; i++) btns[i].disabled = true;
    }

    google.script.run
      .withSuccessHandler(function() {
        loadData();
      })
      .withFailureHandler(function(err) {
        alert('Error: ' + err.message);
        if (row) {
          var rbtns = row.querySelectorAll('.btn-status');
          for (var j = 0; j < rbtns.length; j++) rbtns[j].disabled = false;
        }
      })
      .updateStatus(key, newStatus);
  }

  // ── Helpers ──────────────────────────────────────────────────

  function formatTime(dt) {
    if (!dt) return '';
    var str = String(dt);
    var parts = str.split(' ');
    if (parts.length < 2) return str;
    var date = parts[0];
    var timeParts = parts[1].split(':');
    var h = parseInt(timeParts[0], 10);
    var m = timeParts[1] || '00';
    var ampm = h >= 12 ? 'PM' : 'AM';
    if (h > 12) h -= 12;
    if (h === 0) h = 12;
    return date + ' ' + h + ':' + m + ' ' + ampm;
  }

  function esc(str) {
    if (!str && str !== 0) return '';
    var d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
  }

  function escAttr(str) {
    return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;');
  }
</script>
</body>
</html>
